#!/bin/bash

set -e

echo "--> Adding all ubuntu repositories"
sudo add-apt-repository "deb http://archive.ubuntu.com/ubuntu $(lsb_release -sc) main universe restricted multiverse"
sudo apt-get update > /dev/null

echo "--> Installing dependencies"
sudo apt-get install -qqy debirf > /dev/null

echo "--> Setting up non-privileged user to build as"
sudo useradd debirf

echo "--> Setting up working directories"
export DEBIRF_BUILDD="/tmp/debirf_build"
echo "DEBBIRF_BUILDD is ${DEBIRF_BUILDD}"
mkdir -p $DEBIRF_BUILDD
sudo chown debirf $DEBIRF_BUILDD

echo "build dir"
ls -la $DEBBIRF_BUILDD

echo "--> Building image"
sudo -u debirf sh -c "DEBIRF_BUILDD=$DEBIRF_BUILDD ./script/build"

echo "--> Copying artifacts to output directory"
cp -v $DEBIRF_BUILDD/*.cgz $DEBIRF_BUILDD/vmlinuz* $DEBIRF_BUILDD/*.iso out/

echo "--> The following files were generated"
ls out/
