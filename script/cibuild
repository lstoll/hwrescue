#!/bin/bash

set -e

echo "--> Adding all ubuntu repositories"
sudo add-apt-repository "deb http://archive.ubuntu.com/ubuntu $(lsb_release -sc) main universe restricted multiverse"
sudo apt-get update > /dev/null

echo "--> Installing dependencies"
sudo apt-get install -qqy debirf > /dev/null

echo "--> Setting up non-privileged user to build as"
sudo useradd debirf

echo "--> Setting up working directories"
export DEBIRF_BUILDD=$TRAVIS_BUILD_DIR/debirf_build
echo "DEBBIRF_BUILDD is ${DEBIRF_BUILDD}"
export DEBIRF_OUT=$TRAVIS_BUILD_DIR/out
echo "DEBBIRF_OUT is ${DEBIRF_OUT}"
mkdir -p $DEBIRF_BUILDD $DEBIRF_OUT
sudo chown debirf $DEBIRF_BUILDD $DEBIRF_OUT

ls $DEBBIRF_BUILDD

echo "--> Building image"
sudo -u debirf sh -c "DEBIRF_BUILDD=$DEBIRF_BUILDD ./script/build"

echo "--> Copying artifacts to output directory"
cp -v $DEBIRF_BUILDD/*.cgz $DEBIRF_BUILDD/vmlinuz* $DEBIRF_BUILDD/*.iso $DEBIRF_OUT

echo "--> The following files were generated"
ls $DEBIRF_OUT/
